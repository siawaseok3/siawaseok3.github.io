<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>同期再生：JSONからセットアップ</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }
    textarea {
      width: 100%;
      height: 120px;
      font-family: monospace;
      margin-bottom: 10px;
    }
    select, button {
      margin-top: 5px;
      padding: 5px;
      font-size: 1em;
    }
    video, audio {
      display: block;
      margin-top: 20px;
      max-width: 100%;
    }
  </style>
</head>
<body>

  <h2>ストリームJSONを貼って再生セットアップ</h2>

  <textarea id="jsonInput" placeholder='[{"video": "映像URL", "audio": "音声URL"}, ...]'></textarea>
  <button id="setupButton">セットアップ</button>

  <label for="streamSelect">再生するセットを選択:</label>
  <select id="streamSelect">
    <option value="">-- セットアップしてください --</option>
  </select>
  <button id="playButton">再生</button>

  <video id="video" controls></video>
  <audio id="audio" controls></audio>

  <script>
    const jsonInput = document.getElementById("jsonInput");
    const setupButton = document.getElementById("setupButton");
    const streamSelect = document.getElementById("streamSelect");
    const playButton = document.getElementById("playButton");
    const video = document.getElementById("video");
    const audio = document.getElementById("audio");

    let streamData = [];

    setupButton.addEventListener("click", () => {
      try {
        streamData = JSON.parse(jsonInput.value.trim());
        streamSelect.innerHTML = '<option value="">-- セットを選んでください --</option>';
        streamData.forEach((item, index) => {
          const label = `映像: ${item.video.slice(0, 50)}...`;
          const opt = document.createElement("option");
          opt.value = index;
          opt.textContent = `セット ${index + 1}: ${label}`;
          streamSelect.appendChild(opt);
        });
        alert("セットアップ成功！");
      } catch (e) {
        alert("JSONの形式が正しくありません");
      }
    });

    playButton.addEventListener("click", () => {
      const selectedIndex = streamSelect.value;
      if (selectedIndex === "") {
        alert("セットを選んでください");
        return;
      }

      const selected = streamData[selectedIndex];
      video.src = selected.video;
      audio.src = selected.audio;

      video.load();
      audio.load();

      video.play().catch(() => {});
      audio.play().catch(() => {});
    });

    // 同期処理
    video.addEventListener('play', () => {
      if (audio.paused) audio.play();
    });

    video.addEventListener('pause', () => {
      if (!audio.paused) audio.pause();
    });

    video.addEventListener('seeked', () => {
      audio.currentTime = video.currentTime;
    });

    setInterval(() => {
      if (Math.abs(video.currentTime - audio.currentTime) > 0.3) {
        audio.currentTime = video.currentTime;
      }
    }, 500);
  </script>

</body>
</html>
