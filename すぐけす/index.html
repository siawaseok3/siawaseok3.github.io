<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>æ˜ åƒã¨éŸ³å£°ã®åŒæœŸå†ç”Ÿï¼ˆãƒãƒƒãƒ•ã‚¡ãƒªãƒ³ã‚°å¯¾å¿œæ¸ˆã¿ï¼‰</title>
</head>
<body>
  <h2>æ˜ åƒã¨éŸ³å£°ã®åŒæœŸå†ç”Ÿï¼ˆãƒãƒƒãƒ•ã‚¡ãƒªãƒ³ã‚°ç›£è¦–ï¼‹å·®åˆ†è£œæ­£ï¼‰</h2>
  <video id="video" width="640" controls></video>
  <audio id="audio" controls></audio>
  <p>ğŸ¯ å·®åˆ†ï¼ˆvideo - audioï¼‰ï¼š<span id="diffDisplay">0</span> ms</p>

  <script>
    const video = document.getElementById("video");
    const audio = document.getElementById("audio");
    const diffDisplay = document.getElementById("diffDisplay");
    
    const cooldownCookieName = "audioJumpCooldown";
    let isStartupJumpDone = false;
    let isBuffering = false;

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³Cookieã‚’falseã«åˆæœŸåŒ–
    window.addEventListener('load', () => {
      setCookie(cooldownCookieName, "false", 1);
    });

    // Cookieæ“ä½œé–¢æ•°
    function setCookie(name, value, seconds) {
      const expires = new Date(Date.now() + seconds * 1000).toUTCString();
      document.cookie = `${name}=${value}; expires=${expires}; path=/`;
    }

    function getCookie(name) {
      const match = document.cookie.match(new RegExp("(^| )" + name + "=([^;]+)"));
      return match ? match[2] : null;
    }

    function isJumpCooldown() {
      return getCookie(cooldownCookieName) === "true";
    }

    function startJumpCooldown() {
      setCookie(cooldownCookieName, "true", 1);
      setTimeout(() => setCookie(cooldownCookieName, "false", 1), 1000);
    }

    function jumpAudioToVideo() {
      if (isJumpCooldown()) return;
      // 50ms (0.05ç§’) ã«æ¸›ã‚‰ã—ã¦å¾®èª¿æ•´
      const target = Math.max(0, video.currentTime - 0.05);
      audio.currentTime = target;
      startJumpCooldown();
    }

    function correctPlaybackRate(diff) {
      const abs = Math.abs(diff);

      if (abs < 0.01) {
        audio.playbackRate = 1.0;
      } else if (abs < 0.1) {
        audio.playbackRate = diff > 0 ? 1.02 : 0.98;
      } else if (abs < 1.5) {
        audio.playbackRate = diff > 0 ? 1.06 : 0.94;
      } else if (abs < 2.0) {
        audio.playbackRate = diff > 0 ? 1.1 : 0.9;
      } else {
        audio.playbackRate = 1.0;
        jumpAudioToVideo();
      }
    }

    // ãƒãƒƒãƒ•ã‚¡ãƒªãƒ³ã‚°ç›£è¦–ï¼†éŸ³å£°åˆ¶å¾¡
    video.addEventListener("waiting", () => {
      isBuffering = true;
      audio.pause();
    });

    video.addEventListener("playing", () => {
      if (isBuffering) {
        isBuffering = false;
        if (!video.paused) audio.play();
      }
    });

    video.addEventListener("pause", () => {
      audio.pause();
    });

    // å†ç”Ÿé–‹å§‹æ™‚å‡¦ç†
    video.onplay = () => {
      audio.play();

      if (!isStartupJumpDone) {
        setTimeout(() => {
          audio.currentTime = Math.max(0, video.currentTime - 0.05);
          isStartupJumpDone = true;
        }, 100);
      }
    };

    // ã‚·ãƒ¼ã‚¯æ™‚ã‚¸ãƒ£ãƒ³ãƒ—è£œæ­£
    video.onseeking = () => {
      jumpAudioToVideo();
    };

    // å·®åˆ†ãƒã‚§ãƒƒã‚¯ï¼†å†ç”Ÿé€Ÿåº¦è£œæ­£
    video.ontimeupdate = () => {
      const diff = video.currentTime - audio.currentTime;
      diffDisplay.textContent = `${(diff * 1000).toFixed(0)} ms`;
      correctPlaybackRate(diff);
    };

    // å‹•ç”»ãƒ»éŸ³å£°ã®URLï¼ˆé©å®œå·®ã—æ›¿ãˆï¼‰
    video.src = "https://....."; // æ˜ åƒURL
    audio.src = "https://....."; // éŸ³å£°URLï¼ˆçŸ­ç¸®æ¨å¥¨ï¼‰
  </script>
</body>
</html>
